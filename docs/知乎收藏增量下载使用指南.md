# 知乎收藏增量下载使用指南

## 🚀 功能简介

知乎收藏增量下载功能可以智能跳过已下载的内容，只获取新增的收藏，大幅提升爬取效率。

## 📋 使用方法

### 基本命令

```bash
# 全量爬取（首次使用推荐）
python main.py --platform zhihu --lt qrcode --type collection --mode full

# 增量爬取（定期更新推荐）
python main.py --platform zhihu --lt qrcode --type collection --mode incremental

# 默认模式（等同于全量模式）
python main.py --platform zhihu --lt qrcode --type collection
```

### 模式说明

| 模式 | 参数值 | 功能描述 | 适用场景 |
|------|--------|----------|----------|
| 全量模式 | `--mode full` | 爬取所有收藏内容，包括已存在的 | 首次使用、数据修复 |
| 增量模式 | `--mode incremental` | 只爬取新增内容，跳过已存在的 | 定期更新、节省时间 |

## 🎯 使用场景

### 首次使用
```bash
# 第一次使用，建议全量爬取
python main.py --platform zhihu --lt qrcode --type collection --mode full
```

### 定期更新
```bash
# 后续使用，推荐增量爬取
python main.py --platform zhihu --lt qrcode --type collection --mode incremental
```

## 📊 效率对比

### 实际效果示例
假设你有2000个收藏，已下载了500个：

| 模式 | 处理数量 | 预估时间 | 网络请求 |
|------|----------|----------|----------|
| 全量模式 | 2000个 | 2-3小时 | 2000次 |
| 增量模式 | 1500个 | 1.5-2.2小时 | 1500次 |

*节省时间：约25-30%*

## 🔍 工作原理

### 增量检测机制
1. **扫描现有数据**：程序启动时扫描已下载的内容ID
2. **智能对比**：对每个收藏项检查是否已存在
3. **跳过处理**：已存在内容直接跳过，记录统计信息
4. **正常处理**：新内容按正常流程下载和保存

### 支持的存储方式
- **JSON文件**：扫描 `data/zhihu/json/` 目录下的文件
- **数据库**：查询 `zhihu_content` 表中的记录

## 📝 日志示例

### 增量模式启动日志
```
[ZhihuCrawler.get_user_collections] Incremental mode enabled, loading existing content IDs...
[ContentExistenceChecker] Loaded 74 items from collection_contents_2025-07-08.json
[ContentExistenceChecker] Loaded 74 existing content IDs
[ZhihuCrawler.get_user_collections] Found 74 existing content(s)
```

### 跳过已存在内容日志
```
[ZhihuCrawler.get_collection_contents] Processing answer: 某个回答标题
[ZhihuCrawler.get_collection_contents] Content 1925602391320924740 already exists, skipping...
```

### 完成统计日志
```
[ZhihuCrawler.get_user_collections] Incremental mode completed. Total existing content: 74
[ZhihuCrawler.get_user_collections] Finished processing all collections (Mode: incremental)
```

## ❓ 常见问题

**Q: 增量模式会影响图片下载吗？**
A: 不会。增量模式只跳过已存在的文本内容，对于新内容的图片下载功能完全正常。

**Q: 如何确认增量模式正在工作？**
A: 查看日志中的 "already exists, skipping..." 信息，以及启动时显示的已存在内容数量。

**Q: 数据文件损坏会影响增量模式吗？**
A: 不会。程序会跳过损坏的文件并记录警告，继续处理其他正常文件。

**Q: 可以强制重新下载某个内容吗？**
A: 可以。删除对应的JSON记录或数据库记录，然后使用增量模式即可重新下载。

## 🛠️ 故障排除

### 增量模式没有跳过内容
1. 检查 `data/zhihu/json/` 目录是否存在内容文件
2. 确认文件格式是否正确（有效的JSON格式）
3. 查看日志中的 "Loaded X existing content IDs" 信息

### 跳过了不应该跳过的内容
1. 检查content_id是否重复
2. 确认是否误删了某些内容但记录仍存在
3. 可以使用全量模式重新获取所有内容

## 📈 性能建议

1. **首次使用**：建议使用全量模式获取完整数据
2. **定期更新**：使用增量模式，建议每周或每月运行一次
3. **大量收藏**：增量模式的效率提升随收藏数量增长而更加明显
4. **存储清理**：定期清理不需要的旧数据，保持检测效率

## 🆕 新功能特性 (2025-07-10)

### 图片占位符替换
- **功能**：将文本中的 `[图片]` 替换为真实文件名 `[pic:filename]`
- **效果**：`获利22.4% [pic:image_000.webp] 去年10月...`
- **优势**：保持图片在文本中的准确位置，便于内容重建

### 智能图片过滤
- **功能**：自动跳过data:协议的内联SVG和无效图片
- **效果**：减少错误日志，提高下载成功率
- **优势**：只下载真正的内容图片，避免无用请求

### 日志优化
- **功能**：截断过长URL，优化错误信息显示
- **效果**：日志更清晰易读，便于问题诊断
- **优势**：提升调试和监控体验

## 🔄 更新记录

- **2025-07-10**: 功能完善版本，新增图片占位符替换、智能过滤、日志优化
- **2025-07-08**: 初始版本发布，支持基础增量下载功能
